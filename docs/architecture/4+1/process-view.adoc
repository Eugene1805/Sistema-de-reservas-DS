==== Process View

==== Diagramas de Secuencia


=== Diagrama de Secuencia Crítico: Confirmación de Reserva con Saga y Broker

Este diagrama detalla el flujo crítico de creación y confirmación de una reserva, ilustrando la separación arquitectónica entre la recepción de la solicitud y su procesamiento de negocio para garantizar alto desempeño y consistencia transaccional.

image::SecuenceDiagramConfirmarReserva.png[title="Flujo de Confirmación de Reserva con Saga", align="center"]

==== Descripción de la Estructura y Modelo de Concurrencia

La estructura del diagrama refleja un modelo de **concurrencia asíncrona basada en eventos**, dividiendo la transacción de negocio en dos fases temporales desacopladas:

. **Fase 1: Recepción Síncrona (Cliente-Servidor)**
* **Interacción:** El `Huésped` interactúa con el `API Gateway` y el `ServicioDeReservas`.
* **Modelo de Ejecución:** Se realizan validaciones ligeras (formato, autenticación) y la persistencia inicial de la reserva en estado `PENDIENTE`.
* **Patrón:** Se aplica _Fire-and-Forget_ al publicar el evento en el `Message Broker`.
* **Tiempo Objetivo:** Esta fase está diseñada para completarse en **< 500ms**, retornando un `HTTP 202 Accepted` para liberar el hilo del cliente inmediatamente.

. **Fase 2: Procesamiento Asíncrono (Orquestación de Saga)**
* **Interacción:** El `Reservation Worker` actúa como **Orquestador de la Saga**, consumiendo mensajes del Broker de forma desacoplada.
* **Coordinación:** El Worker ejecuta llamadas RPC síncronas hacia los servicios de dominio (`ServicioDeInventario` y `ServicioDePago`) para asegurar la confirmación inmediata de cada paso lógico.
* **Política de Consistencia:** Se utiliza **Consistencia Eventual**. El sistema asegura que todos los servicios convergerán a un estado consistente (Confirmado o Cancelado), aunque no ocurra en el mismo instante exacto.

==== Justificación del Estilo Arquitectónico

El diseño presentado materializa el estilo **Orientado a Servicios (SOA) con Arquitectura Basada en Eventos (EDA)**. La decisión de introducir un _Message Broker_ como frontera y un _Worker_ como controlador de la lógica compleja justifica la necesidad de aislar el núcleo del negocio de la latencia inherente a servicios externos (como pasarelas de pago) y operaciones intensivas de base de datos.

==== Cumplimiento de Escenarios de Atributos de Calidad

La estructura y los patrones de interacción demostrados en el diagrama satisfacen los siguientes drivers arquitectónicos:

* **Desempeño y Latencia (QAS-02, QAS-03):**
Al desacoplar el procesamiento pesado de la fase síncrona, el sistema cumple con la métrica de respuesta al usuario (< 2.5s) incluso bajo carga. La cola de mensajes actúa como un amortiguador (_load leveling_) que protege a los servicios backend de picos de tráfico repentinos.

* **Fiabilidad y Atomicidad (QAS-09, CRN-02):**
El uso del patrón **Saga** garantiza la atomicidad de la transacción distribuida sin bloqueos de base de datos. El diagrama muestra explícitamente el flujo de **Compensación** (bloque `alt` de fallo): si el pago es rechazado, el orquestador revierte los cambios previos (`liberarHabitación`), asegurando que no existan inconsistencias de datos (habitaciones bloqueadas sin pago).

* **Escalabilidad (QAS-04):**
El componente `Reservation Worker` es _stateless_. Esto permite escalar horizontalmente añadiendo más instancias de workers para aumentar la velocidad de procesamiento de la cola durante eventos de alta demanda, sin afectar la disponibilidad de la API pública.

* **Disponibilidad y Tolerancia a Fallos (QAS-06):**
La persistencia del mensaje en el `Broker` asegura que, ante una caída temporal del `ServicioDePago` o `Inventario`, la solicitud del usuario no se pierde. El Worker puede reintentar el procesamiento posteriormente, garantizando la continuidad del servicio.

=== Diagrama de Secuencia de Alto Valor: Proceso de Pago con Idempotency-Key
Este diagrama detalla el flujo crítico de procesamiento de pagos, ilustrando los mecanismos de seguridad y consistencia de datos necesarios para garantizar la integridad financiera del sistema, evitando duplicidades y manejando fallos externos de manera resiliente.

image::DiagramaSecuenciaProcesoPago.png[title="Proceso de Pago Seguro con Idempotency-Key", align="center"]

==== Descripción de la Estructura y Modelo de Concurrencia

La estructura del diagrama refleja un modelo de concurrencia híbrida, diseñada para priorizar la consistencia fuerte en la fase financiera y el desempeño en la fase de notificación. La transacción se divide en tres fases lógicas:

. **Fase 1: Validación y Bloqueo Optimista (Síncrona)**
* **Interacción:** El Huésped inicia la solicitud a través del API Gateway, el cual delega al ServicioDePago.
* **Modelo de Ejecución:** Se aplica una política de Consistencia Fuerte. Antes de cualquier interacción externa, el servicio consulta y escribe en el RepositorioPagos.
* **Patrón:** Se utiliza el patrón Idempotency Key. La inserción del estado PENDIENTE actúa como un bloqueo lógico (lock) para prevenir condiciones de carrera ante clics dobles del usuario.
* **Tiempo Objetivo:** Esta fase de validación interna debe completarse en milisegundos para proceder rápidamente al cobro.

. **Fase 2: Ejecución Financiera y Compensación (Síncrona con Timeout)**
* **Interacción:** El ServicioDePago invoca a la PasarelaExterna. Esta es una llamada bloqueante crítica.
* **Manejo de Fallos:** Se definen bloques de excepciones para manejar Timeouts (> 4 segundos según QAS-02 ). Si la pasarela no responde o falla, se dispara inmediatamente una lógica de compensación (revertirCargo) para garantizar la atomicidad de la operación.
* **Política de Consistencia:** Se mantiene la consistencia transaccional del estado financiero. Si falla la pasarela, el sistema revierte su estado interno a FALLIDO.

. **Fase 3: Notificación y Desacoplamiento (Asíncrona)**
* **Interacción:** Una vez confirmado el pago, el ServicioDePago publica el evento en el Message Broker.
* **Patrón:** Se aplica Fire-and-Forget. El servicio no espera a que los consumidores (Reservas, Inventario) procesen el evento.
* **Política de Consistencia:** Transición a Consistencia Eventual para el resto del ecosistema. El usuario recibe su confirmación (200 OK) inmediatamente, mientras que la actualización de inventario ocurre en segundo plano.

==== Justificación del Estilo Arquitectónico

El diseño materializa la arquitectura en capas con orientación a servicios (SOA), integrando patrones de resiliencia. La inclusión del API Gateway como punto de entrada único aísla la lógica de pago de la complejidad de seguridad perimetral. El uso del patrón Repository para la gestión del estado (RepositorioPagos) permite desacoplar la lógica de negocio de la tecnología de persistencia, facilitando la auditoría de transacciones. Finalmente, la integración del Message Broker  evita que la latencia de subsistemas secundarios degrade la experiencia de pago del usuario.

==== Cumplimiento de Escenarios de Atributos de Calidad

La estructura y los patrones de interacción demostrados en el diagrama satisfacen los siguientes drivers arquitectónicos:

* **Disponibilidad e Idempotencia (QAS-07, CRN-02):** El bloque alt inicial implementa la táctica de Idempotencia. Al verificar la existencia de la transacción ([transacción != null]) antes de procesar, el sistema garantiza que los reintentos automáticos por fallos de red no generen cobros duplicados, cumpliendo estrictamente con la preocupación crítica de integridad financiera.

* **Fiabilidad y Tolerancia a Fallos (QAS-09):** El diagrama modela explícitamente la Tolerancia a fallos en transacciones. Mediante el fragmento de ruptura (bloque de error/timeout), el sistema asegura que ante una falta de respuesta de la PasarelaExterna, se ejecute una reversión activa (revertirCargo) y se actualice el estado local, evitando inconsistencias entre el dinero descontado al usuario y el registro del sistema.

* **Desempeño (QAS-02):** La publicación asíncrona del evento PagoAprobado hacia el Message Broker al final del flujo exitoso contribuye a mantener los tiempos de respuesta bajo control (< 4s en el 99% de los casos ). Esto libera los recursos del ServicioDePago inmediatamente después de la confirmación financiera, sin bloquearse por la lógica de negocio de otros servicios.

* **Seguridad (CRN-01):** Aunque implícito en el flujo, la mediación del API Gateway asegura que los datos sensibles de pago (DatosDePago) viajen a través de un canal cifrado y autenticado antes de llegar al servicio interno, protegiendo la información personal del huésped.
